#' Calculate the perplexity from a single celda run
#' 
#' Perplexity can be seen as a measure of how well a provided set of 
#' cluster assignments fit the count data being modeled.
#' 
#' Perplexity is defined in LDA as the exp of the log likelihood of the model
#' divided by the total amount of word tokens. The corresponding perplexity
#' for the celda models are derived in their respective model description 
#' documents. These documents will not be made publicly available until 
#' after publication of celda.
#' 
#' @param counts The count matrix modeled in the celdaRun parameter
#' @param celda.mod A single celda run (usually from the _res.list_ property of a celda_list)
#' @param precision The amount of bits of precision to pass to Rmpfr
#' @return The perplexity for the provided chain as an mpfr number
#' @export
calculatePerplexity = function(counts, celda.mod, precision=128) {
  UseMethod("calculatePerplexity", celda.mod)
}


#' Calculate and visualize perplexity of all models in a celda_list, with resampling
#' 
#' Calculates the perplexity (a measure of how well celda's cluster assignments fit the data) for every celda model in a celda_list generated by the celda() function. Perplexity of the cluster assignments given the provided count matrix,
#' as well as resamplings of that count matrix, provide a distribution of perplexities and a better sense of the quality of a given K/L choice. 
#' 
#' @param celda.list A celda_list object as returned from *celda()*
#' @param counts The counts matrix used to generate the provided celda.list
#' @param resample The number of times to resample the counts matrix for evaluating perplexity. Works with method="perplexity."
#' @param title Title to be appended to the perplexity plot title. Default is "".
#' @return A list with a data frame summarizing all of the calculated perplexities, and a ggplot2 object visualizing them.
#' @export
calculatePerplexityWithResampling <- function(celda.list, counts, resample,
                                              title="") {
  
  perplexities.per.model = lapply(celda.list$res.list, function(mod){
    # TODO Can we re-use the same counts matrices in every model evaluation?
    countsList = list(counts)
    for(i in 1:resample) {
      countsList[[i]] = resampleCountMatrix(counts)
      i = i - 1  
    }
    
    perplexities = lapply(countsList, function(counts, mod){ 
      class(counts) = class(mod)
      UseMethod("calculatePerplexity", object=mod)
    }, mod)
    
    perplexity.df = data.frame(perplexity=unlist(perplexities))
    if (!is.null(mod$K)) { perplexity.df$k = rep(mod$K, nrow(perplexity.df)) }
    if (!is.null(mod$L)) { perplexity.df$l = rep(mod$L, nrow(perplexity.df)) }
    return(perplexity.df)
  })
  
  plot.df = do.call("rbind", perplexities.per.model)
  
  l.means.by.k = setNames(aggregate(plot.df$perplexity,
                                    by=list(plot.df$k, plot.df$l),
                                    FUN=mean),
                          c("k", "l", "perplexity"))
  l.means.by.k$l = as.factor(l.means.by.k$l)
  l.means.by.k$k = as.factor(l.means.by.k$k)
  
  perp.plot = ggplot2::ggplot(plot.df, ggplot2::aes(x=k, y=perplexity)) +
              ggplot2::geom_jitter(height=0, width=0.1, ggplot2::aes(color=as.factor(plot.df$l))) +
              ggplot2::ggtitle(paste("Perplexity for All Provided Chains",
                                     "\n", title)) + 
              ggplot2::xlab("K") + ggplot2::ylab("Perplexity") +
              ggplot2::scale_color_discrete(name="L") +
              ggplot2::theme_bw() +
              ggplot2::geom_path(data=l.means.by.k,
                                 ggplot2::aes(x=as.numeric(k), y=perplexity, group=l, color=l))
  
  return(list(perplexity.info=plot.df, plot=perp.plot))
}

# Resample a counts matrix for evaluating perplexity
#
# Normalizes each column (cell) of a count matrix by the column sum to 
# create a distribution of observing a given number of counts for a given gene in that cell,
# then samples across all cells.
#
# This is primarily used to evaluate the stability of the perplexity for a given K/L combination.
# 
# @param celda.mod A single celda run (usually from the _res.list_ property of a celda_list)
# @return The perplexity for the provided chain as an mpfr number
resampleCountMatrix = function(count.matrix) {
  colsums  = colSums(count.matrix)
  prob     = t(t(count.matrix) / colsums)
  resample = sapply(1:ncol(count.matrix), function(idx){
                      rmultinom(n=1, size=colsums[idx], prob=prob[, idx])
                   })
  return(resample)
}
